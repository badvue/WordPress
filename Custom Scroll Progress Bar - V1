add_action('wp_body_open', function() {
    if (is_single()) {
        echo '<div id="wpcode-progress-bar"></div>';
    }
});

add_action('wp_head', function() {
    if (is_single()) {
        echo '<style>
            #wpcode-progress-bar {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 4px;
                background-color: #0d6efd;
                z-index: 99;
                transform: scaleX(0);
                transform-origin: left;
                will-change: transform;
            }
            @media (min-width: 1025px) {
                #wpcode-progress-bar {
                    display: none;
                }
            }
        </style>';
    }
});

add_action('wp_footer', function() {
    if (is_single()) {
        echo '<script>
            document.addEventListener("DOMContentLoaded", function() {
                const progressBar = document.getElementById("wpcode-progress-bar");
                const articleContent = document.querySelector(".entry-content");

                if (!progressBar || !articleContent) return;

                let articleBottom = articleContent.offsetTop + articleContent.offsetHeight;
                let ticking = false;

                function updateProgressBar() {
                    const scrollTop = window.scrollY;
                    const viewportHeight = window.innerHeight;
                    const maxScrollableHeight = Math.max(articleBottom - viewportHeight, 1);
                    const progress = Math.min(scrollTop / maxScrollableHeight, 1);
                    
                    progressBar.style.transform = `scaleX(${progress})`;
                }

                function updateArticleBottom() {
                    articleBottom = articleContent.offsetTop + articleContent.offsetHeight;
                    updateProgressBar();
                }

                document.addEventListener("scroll", function() {
                    if (!ticking) {
                        requestAnimationFrame(() => {
                            updateProgressBar();
                            ticking = false;
                        });
                        ticking = true;
                    }
                }, { passive: true });

                let resizeTimeout;
                window.addEventListener("resize", function() {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(updateArticleBottom, 200);
                });

                articleContent.querySelectorAll("img[loading=lazy]").forEach(img => {
                    img.addEventListener("load", function() {
                        updateArticleBottom();
                        this.removeEventListener("load", arguments.callee);
                    });
                });

                updateArticleBottom();
                updateProgressBar();
            });
        </script>';
    }
});
