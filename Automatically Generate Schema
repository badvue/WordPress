function generate_schema() {
    // Get post or page data
    global $post;

    // Initialize schema array
    $schema = array(
        '@context' => 'http://schema.org',
        '@type' => 'Article',
        'headline' => get_the_title(),
        'author' => array(
            '@type' => 'Person',
            'name' => get_the_author_meta('display_name', $post->post_author)
        ),
        'datePublished' => get_the_date('c'),
        'image' => get_the_post_thumbnail_url($post->ID, 'full'),
        'url' => get_permalink()
    );

    // Extract articleSection from h2 tags
    $article_sections = array();
    preg_match_all('/<h2[^>]*>(.*?)<\/h2>/i', $post->post_content, $matches);
    if (!empty($matches[1])) {
        foreach ($matches[1] as $section) {
            // Strip HTML tags and decode HTML entities
            $section = wp_strip_all_tags($section);
            $section = html_entity_decode($section);
            // Trim leading and trailing whitespace
            $section = trim($section);
            // Add a space after the period to separate the number from the text
            $section = preg_replace('/(\d+)\./', '$1. ', $section);
            $article_sections[] = $section;
        }
    }
    $schema['articleSection'] = $article_sections;

    // Sanitize articleBody and remove extra line breaks
    $dom = new DOMDocument();
    $dom->loadHTML(mb_convert_encoding($post->post_content, 'HTML-ENTITIES', 'UTF-8'));

    // Remove h2 tags
    $h2_tags = $dom->getElementsByTagName('h2');
    foreach ($h2_tags as $h2_tag) {
        $h2_tag->parentNode->removeChild($h2_tag);
    }

    // Get sanitized articleBody
    $article_body_sanitized = $dom->saveHTML();
    $article_body_sanitized = wp_strip_all_tags($article_body_sanitized);

    // Decode HTML entities
    $article_body_sanitized = html_entity_decode($article_body_sanitized, ENT_QUOTES | ENT_HTML5);

    // Remove line breaks
    $article_body_sanitized = str_replace(array("\r", "\n"), '', $article_body_sanitized);
    $article_body_sanitized = trim($article_body_sanitized); // Trim leading/trailing whitespace

    $schema['articleBody'] = $article_body_sanitized;

    // Encode schema to JSON
    $json_ld = json_encode($schema, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);

    // Buffer output
    ob_start(); ?>
    <script type="application/ld+json"><?php echo $json_ld; ?></script>
    <?php $output = ob_get_clean();

    // Output the buffered content just before </head>
    echo $output;
}

// Call the function just before </head>
add_action('wp_head', 'generate_schema', 999);
