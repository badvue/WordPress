// This code is to be inserted into the functions.php or using WPCode. It will read through the page and add items necessary to generate the schema for WordPress.
function generate_schema() {
    // Check if the current page is a post
    if (!is_single()) {
        return; // Exit if not a post
    }

    // Get post data
    global $post;

    // Initialize schema array
    $schema = array(
        '@context' => 'http://schema.org',
        '@type' => 'Article',
        'headline' => get_the_title(),
        'author' => array(
            '@type' => 'Person',
            'name' => get_the_author_meta('display_name', $post->post_author)
        ),
        'datePublished' => get_the_date('c'),
        'url' => get_permalink()
    );

    // Extract articleSection from h2 tags if present
    $article_sections = array();
    $has_h2_tags = preg_match_all('/<h2[^>]*>(.*?)<\/h2>/i', $post->post_content, $matches);
    if ($has_h2_tags) {
        foreach ($matches[1] as $section) {
            // Strip HTML tags, decode HTML entities, and replace non-breaking spaces with regular spaces
            $section = wp_strip_all_tags(html_entity_decode(str_replace('&nbsp;', ' ', $section), ENT_QUOTES, 'UTF-8'), true);
            // Trim leading and trailing whitespace
            $section = trim($section);
            // Add to article sections array
            $article_sections[] = $section;
        }
        $schema['articleSection'] = $article_sections;
    }

    // Extract images from post content
    $image_urls = array();

    // Add featured image URL to image_urls array
    $featured_image_url = get_the_post_thumbnail_url($post->ID, 'full');
    if ($featured_image_url) {
        $image_urls[] = $featured_image_url;
    }

    // Match all image tags in post content
    preg_match_all('/<img[^>]+src=[\'"]([^\'"]+)[\'"][^>]*>/i', $post->post_content, $matches);
    if (!empty($matches[1])) {
        // Add matched image URLs to image_urls array
        $image_urls = array_merge($image_urls, $matches[1]);
    }

    // Add images to schema
    if (!empty($image_urls)) {
        $schema['image'] = $image_urls; // Include multiple images
    }

    // Remove h2 headers from the post content
    $content_without_h2 = preg_replace('/<h2[^>]*>.*?<\/h2>/i', '', $post->post_content);

    // Extract plain text content of the post and remove newline characters
    $plain_text_content = wp_strip_all_tags($content_without_h2);
    $plain_text_content = str_replace(array("\r", "\n"), '', $plain_text_content);

    // Replace non-breaking spaces with regular spaces
    $plain_text_content = str_replace('&nbsp;', ' ', $plain_text_content);

    // Replace em dashes with plain text
    $plain_text_content = str_replace('â€”', '-', $plain_text_content);

    $schema['articleBody'] = $plain_text_content;

    // Encode schema to JSON
    $json_ld = json_encode($schema, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT | JSON_INVALID_UTF8_IGNORE);

    // Buffer output
    ob_start(); ?>
    <script type="application/ld+json"><?php echo $json_ld; ?></script>
    <?php $output = ob_get_clean();

    // Output the buffered content just before </head>
    echo $output;
}

// Call the function just before </head>
add_action('wp_head', 'generate_schema', 999);
